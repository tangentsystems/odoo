<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="view_account_payment_form_usa" model="ir.ui.view">
        <field name="name">account.payment.form.usa</field>
        <field name="model">account.payment</field>
        <field name="inherit_id" ref="account.view_account_payment_form"/>
        <field name="arch" type="xml">
            <!--Void Header-->
            <header position="after">
                <field name="has_been_voided" invisible="1"/>
                <div class="alert alert-warning" role="alert" style="margin-bottom:0px; text-align:center;"
                     attrs="{'invisible': [('has_been_voided','=',False)]}">
                    This payment has been <span style="font-weight:bold;">voided.</span>
                </div>
            </header>

            <field name="payment_transaction_id" position="after">
                <field name="ar_in_charge" attrs="{'invisible': [('payment_type', '!=', 'inbound')]}"/>
                <field name="show_cancel_button" invisible="1"/>
                <field name="has_open_invoice" invisible="1"/>
                <field name="display_applied_invoices" invisible="1"/>
            </field>

            <field name="payment_transaction_id" position="attributes">
                <attribute name="attrs">
                    {'invisible': [('payment_transaction_id', '=', False)],
                    'readonly': True}
                </attribute>
            </field>

            <!-- New Payment Layout-->
            <field name="partner_type" position="attributes">
                <attribute name="invisible">1</attribute>
            </field>
            <field name="payment_type" position="attributes">
                <attribute name="invisible">1</attribute>
            </field>

            <field name="journal_id" position="attributes">
                <attribute name="invisible">1</attribute>
                <attribute name="widget"></attribute>
            </field>

            <field name="partner_id" position="replace">
                <field name="partner_id" string="Customer"
                       attrs="{'required': ['&amp;', ('state', '=', 'draft'), ('payment_type', 'in', ('inbound', 'outbound'))],
                       'invisible': ['|', ('partner_type', '!=', 'customer'), ('payment_type', 'not in', ('inbound', 'outbound'))],
                       'readonly': [('state', '!=', 'draft')]}"
                       context="{'default_is_company': True, 'default_supplier': payment_type == 'outbound', 'default_customer': payment_type == 'inbound'}"/>
                <field name="partner_id" string="Vendor"
                       attrs="{'required': ['&amp;', ('state', '=', 'draft'), ('payment_type', 'in', ('inbound', 'outbound'))],
                       'invisible': ['|', ('partner_type', '!=', 'supplier'), ('payment_type', 'not in', ('inbound', 'outbound'))],
                       'readonly': [('state', '!=', 'draft')]}"
                       context="{'default_is_company': True, 'default_supplier': payment_type == 'outbound', 'default_customer': payment_type == 'inbound'}"/>
                <field name="journal_id" attrs="{'readonly': [('state', '!=', 'draft')],
                    'required': [('payment_type', '!=', 'transfer')],
                    'invisible': [('payment_type', '=', 'transfer')]}"
                    string="Bank Account"/>
            </field>

            <field name="destination_journal_id" position="before">
                <field name="journal_id" attrs="{'readonly': [('state', '!=', 'draft')],
                    'required': [('payment_type', '=', 'transfer')],
                    'invisible': [('payment_type', '!=', 'transfer')]}"
                    string="Transfer From"/>
            </field>

            <field name="payment_method_id" position="replace">
            </field>

            <field name="journal_id" position="after">
                <field name="payment_method_id" string="Payment Method" attrs="{'readonly': [('state', '!=', 'draft')]}" options="{'no_create_edit': True, 'no_create': True}"/>
                <field name="currency_id" options="{'no_create': True, 'no_open': True}"
                       groups="base.group_multi_currency"
                       attrs="{'readonly': [('state', '!=', 'draft')],
                       'invisible': [('display_applied_invoices', '=', False)]}"/>
            </field>

            <button name="button_journal_entries" position="attributes">
                <attribute name="string">Journal Entry</attribute>
            </button>

            <label for="amount" position="attributes">
                <attribute name="attrs">{'invisible': [('display_applied_invoices', '=', True)]}
                </attribute>
            </label>

            <div name="amount_div" position="attributes">
                <attribute name="attrs">{'invisible': [('display_applied_invoices', '=', True)]}
                </attribute>
            </div>

            <!--Open Invoices-->
            <button name="button_invoices" position="attributes">
                <attribute name="invisible">1</attribute>
            </button>

            <button name="open_payment_matching_screen" position="attributes">
                <attribute name="invisible">1</attribute>
            </button>

            <sheet position="inside">
                <!--Customer Payment-->
                <notebook attrs="{'invisible': ['|', '|', ('has_open_invoice', '=', False), ('state', '!=', 'draft'),
                    ('payment_type', '!=', 'inbound')]}">
                    <page string="Open Invoices">
                        <field name="open_invoice_ids" context="{'default_payment_id': id}"
                             attrs="{'readonly': [('state', '!=', 'draft')]}">
                        </field>
                    </page>
                </notebook>

                <notebook attrs="{'invisible': ['|', '|', '|', ('state', 'in', ['draft', 'cancelled']), ('payment_type', '!=', 'inbound'),
                                 ('open_invoice_ids', '=', []),
                                '&amp;', ('payment_type', '=', 'inbound'), ('partner_type', '=', 'supplier')]}">
                    <page string="Applied Invoices">
                        <field name="open_invoice_ids" context="{'default_payment_id': id}"
                               attrs="{'readonly': [('state', '!=', 'draft')]}">
                        </field>
                    </page>
                </notebook>

                <!--Bill Payment-->
                <notebook attrs="{'invisible': ['|', '|', ('has_open_invoice', '=', False), ('state', '!=', 'draft'),
                    ('payment_type', '!=', 'outbound')]}">
                    <page string="Open Bills">
                        <field name="open_invoice_ids" context="{'default_payment_id': id}"
                             attrs="{'readonly': [('state', '!=', 'draft')]}">
                        </field>
                    </page>
                </notebook>

                <notebook attrs="{'invisible': ['|', '|', '|', ('state', 'in', ['draft', 'cancelled']), ('payment_type', '!=', 'outbound'),
                                  ('open_invoice_ids', '=', []),
                                '&amp;', ('payment_type', '=', 'outbound'), ('partner_type', '=', 'customer')]}">
                    <page string="Applied Bills">
                        <field name="open_invoice_ids" context="{'default_payment_id': id}"
                             attrs="{'readonly': [('state', '!=', 'draft')]}">
                        </field>
                    </page>
                </notebook>

                <group class="oe_subtotal_footer oe_right" colspan="2" name="payment_total"
                       attrs="{'invisible': ['|', '|', '|', ('payment_type', '=', 'transfer'),
                        '&amp;', ('open_invoice_ids', '=', []), ('has_open_invoice', '=', False),
                        '&amp;', ('payment_type', '=', 'outbound'), ('partner_type', '=', 'customer'),
                        '&amp;', ('payment_type', '=', 'inbound'), ('partner_type', '=', 'supplier')]}">
                    <field name="payment_with_invoices" widget='monetary' options="{'currency_field': 'currency_id'}"
                        attrs="{'invisible': [('payment_type', '!=', 'inbound')]}" string="Payment with Invoices"/>
                    <field name="payment_with_invoices" widget='monetary' options="{'currency_field': 'currency_id'}"
                        attrs="{'invisible': [('payment_type', '!=', 'outbound')]}" string="Payment with Bills"/>
                    <field name="outstanding_payment" widget='monetary' options="{'currency_field': 'currency_id'}"/>
                    <div class="oe_subtotal_footer_separator oe_inline o_td_label">
                        <label for="amount" />
                    </div>
                    <field name="amount" nolabel="1" class="oe_subtotal_footer_separator"
                           widget='monetary' options="{'currency_field': 'currency_id'}"
                           attrs="{'readonly': [('state', '!=', 'draft')]}" />
                </group>
            </sheet>
        </field>
    </record>

    <!-- Rename Receive Payment popup -->
    <record id="account.action_account_invoice_payment" model="ir.actions.act_window">
        <field name="name">Receive Payment</field>
    </record>

    <!-- Rename Make A Refund popup -->
    <record id="action_account_customer_credit_notes_usa" model="ir.actions.act_window">
        <field name="name">Make A Refund</field>
        <field name="res_model">account.payment</field>
        <field name="view_type">form</field>
        <field name="view_mode">form</field>
        <field name="view_id" ref="account.view_account_payment_invoice_form"/>
        <field name="context">{'default_invoice_ids': [(4, active_id, None)]}</field>
        <field name="target">new</field>
    </record>

    <!--Receive Payment in Customer Invoice-->
    <record id="view_account_payment_method_form_usa" model="ir.ui.view">
        <field name="name">account.payment.method.form.usa</field>
        <field name="model">account.payment</field>
        <field name="inherit_id" ref="account.view_account_payment_invoice_form"/>
        <field name="arch" type="xml">
            <field name="journal_id" position="attributes">
                <attribute name="string">Bank Account</attribute>
                <attribute name="attrs">{'required': [('amount', '!=', 0)], 'invisible': [('amount', '=', 0)]}</attribute>
            </field>

            <field name="payment_method_id" position="replace">
                <field name="payment_method_id" string="Payment Method" widget="selection" attrs="{'invisible': [('amount', '=', 0)]}"/>
            </field>

            <!--Handle Writeoff-->
            <field name="payment_difference_handling" position="attributes">
                <attribute name="invisible">1</attribute>
            </field>
            <field name="payment_difference_handling" position="after">
                <field name="payment_writeoff_option" widget="radio" nolabel="1"/>
            </field>
            <xpath expr="//field[@name='writeoff_account_id']/.." position="attributes">
                <attribute name="attrs">{'invisible': [('payment_writeoff_option','=','open')]}</attribute>
            </xpath>
            <field name="writeoff_account_id" position="attributes">
                <attribute name="attrs">{'required': [('payment_writeoff_option', '=', 'reconcile')]}</attribute>
            </field>
            <field name="writeoff_label" position="attributes">
                <attribute name="attrs">{'required': [('payment_writeoff_option', '=', 'reconcile')]}</attribute>
            </field>

            <!--&lt;!&ndash;Hide default write-off in Receive Payment&ndash;&gt;-->
            <!--<xpath expr="//label[@for='payment_difference']/.." position="attributes">-->
                <!--<attribute name="invisible">1</attribute>-->
            <!--</xpath>-->
        </field>
    </record>

    <!-- Register payment from several invoices -->
    <record id="view_account_payment_from_invoices_usa" model="ir.ui.view">
        <field name="name">account.register.payments.wizard.usa</field>
        <field name="model">account.register.payments</field>
        <field name="inherit_id" ref="account.view_account_payment_from_invoices"/>
        <field name="arch" type="xml">
            <field name="journal_id" position="attributes">
                <attribute name="string">Bank Account</attribute>
            </field>

            <field name="payment_method_id" position="replace">
                <field name="payment_method_id" string="Payment Method" widget="selection" attrs="{'invisible': [('amount', '=', 0)]}"/>
            </field>
        </field>
    </record>

    <!--Customer Payment Tree View-->
    <record id="account.view_account_payment_tree" model="ir.ui.view">
        <field name="priority" eval="10" />
    </record>

    <record id="view_account_payment_method_tree_usa" model="ir.ui.view">
        <field name="name">account.payment.method.tree.usa</field>
        <field name="model">account.payment</field>
        <field name="inherit_id" ref="account.view_account_payment_tree"/>
        <field name="arch" type="xml">
            <field name="payment_date" position="after">
                <field name="move_name" string="Number"/>
            </field>
            <field name="journal_id" position="attributes">
                <attribute name="string">Bank Account</attribute>
            </field>
            <field name="payment_method_id" position="attributes">
                <attribute name="string">Payment Method</attribute>
            </field>
            <field name="partner_id" position="attributes">
                <attribute name="string">Customer/Vendor</attribute>
            </field>
            <field name="state" position="after">
                <field name="has_been_cashed"/>
                <field name="has_been_voided"/>
            </field>
        </field>
    </record>

    <!--Bill Payment Tree View-->
    <record id="view_account_supplier_payment_tree_usa" model="ir.ui.view">
        <field name="name">account.supplier.payment.tree.usa</field>
        <field name="model">account.payment</field>
        <field name="inherit_id" ref="account.view_account_supplier_payment_tree"/>
        <field name="arch" type="xml">
            <field name="payment_date" position="after">
                <field name="move_name" string="Number"/>
            </field>
            <field name="payment_method_id" position="attributes">
                <attribute name="string">Payment Method</attribute>
            </field>
            <field name="journal_id" position="after">
                <field name="check_number_text" string="Check Number"/>
            </field>
            <field name="partner_id" position="attributes">
                <attribute name="string">Customer/Vendor</attribute>
            </field>
            <field name="state" position="after">
                <field name="has_been_cashed"/>
                <field name="has_been_voided"/>
            </field>
        </field>
    </record>

    <!-- Internal Transfer Tree View -->
    <record id="view_account_internal_transfer_tree_usa" model="ir.ui.view">
        <field name="name">account.internal.transfer.tree.usa</field>
        <field name="model">account.payment</field>
        <field name="inherit_id" ref="view_account_payment_method_tree_usa"/>
        <field name="mode">primary</field>
        <field name="arch" type="xml">
            <field name="partner_id" position="attributes">
                <attribute name="invisible">1</attribute>
            </field>
        </field>
    </record>

    <record id="action_account_pay_bill_usa" model="ir.actions.act_window">
        <field name="name">Pay Bill</field>
        <field name="res_model">account.payment</field>
        <field name="view_type">form</field>
        <field name="view_mode">form</field>
        <field name="view_id" ref="account.view_account_payment_invoice_form"/>
        <field name="context">{'default_invoice_ids': [(4, active_id, None)]}</field>
        <field name="target">new</field>
    </record>

    <!-- Change Payments action title-->
    <record id="account.action_account_payments" model="ir.actions.act_window">
        <field name="name">Customer Payments</field>
    </record>
    <record id="account.action_account_payments_payable" model="ir.actions.act_window">
        <field name="name">Bill Payments</field>
    </record>

    <!-- Change Payments menu title -->
    <record id="account.menu_action_account_payments_receivable" model="ir.ui.menu">
        <field name="name">Customer Payments</field>
    </record>
    <record id="account.menu_action_account_payments_payable" model="ir.ui.menu">
        <field name="name">Bill Payments</field>
    </record>

    <!-- Add filter in range -->
    <record id="view_account_payment_search_usa" model="ir.ui.view">
        <field name="name">account.payment.search.usa</field>
        <field name="model">account.payment</field>
        <field name="inherit_id" ref="account.view_account_payment_search"/>
        <field name="arch" type="xml">
            <!-- Extend search -->
            <field name="name" position="attributes">
                <attribute name="filter_domain">['|', ('name', 'ilike', self), '|', ('communication', 'ilike', self), ('move_name', 'ilike', self)]</attribute>
            </field>

            <field name="company_id" position="after">
                <!-- This is a widget filter
                    We have the syntax as follows: name is the specific field, string is the name of QWeb template,
                     context is additional parameters that you want to transfer and help is always "__widget__"
                -->
                <filter name="amount" string="AmountSearchRange" help="__widget__"
                        context='{"title_display": "Search by Payment Amount"}'/>
                <separator/>
            </field>

            <filter name="outbound_filter" position="attributes">
                <attribute name="invisible">1</attribute>
            </filter>

            <filter name="inbound_filter" position="attributes">
                <attribute name="invisible">1</attribute>
            </filter>

            <filter domain="[('payment_type','=','transfer')]" position="attributes">
                <attribute name="invisible">1</attribute>
            </filter>

            <filter context="{'group_by': 'state'}" position="attributes">
                <attribute name="string">Status</attribute>
            </filter>

            <filter context="{'group_by': 'partner_id'}" position="attributes">
                <attribute name="string">Customer/Vendor</attribute>
                <!--<attribute name="invisible">context.get('default_payment_type') != 'inbound'</attribute>-->
            </filter>

            <filter context="{'group_by': 'journal_id'}" position="attributes">
                <attribute name="string">Bank Account</attribute>
            </filter>

            <filter name="state_sent" position="before">
                <filter string="Checks Have Been Cashed"
                        domain="[('payment_method_id.code', 'in', ['check_printing', 'batch_payment']),
                        ('has_been_cashed', '=', True)]" name="checks_been_cashed"/>
                <filter string="Checks to Cash"
                        domain="[('payment_method_id.code', 'in', ['check_printing', 'batch_payment']),
                        ('has_been_cashed', '=', False), ('state', 'in', ['posted', 'sent'])]" name="checks_to_cash"/>
            </filter>

            <!--<filter context="{'group_by': 'partner_id'}" position="before">
                <filter string="Vendor" context="{'group_by': 'partner_id'}"
                        invisible="context.get('default_payment_type') != 'outbound'" />
            </filter>-->
        </field>
    </record>

    <!--Cancel and Delete button in Payment Form-->
    <record id="view_account_payment_form_button_usa" model="ir.ui.view">
        <field name="name">account.payment.cancel.button.usa</field>
        <field name="model">account.payment</field>
        <field name="inherit_id" ref="account_cancel.payment_cancel_form_inherit"/>
        <field name="arch" type="xml">
            <button name="cancel" position="attributes">
                <attribute name="invisible">1</attribute>
            </button>
            <xpath expr="//header/field[@name='state']" position="before">
                <button name="cancel" string="Cancel" attrs="{'invisible':[('show_cancel_button', '!=', 1)]}"
                        type="object" confirm="Are you sure you want to cancel this payment?"/>
                <button name="cancel" string="Cancel" attrs="{'invisible':[('show_cancel_button', '!=', 2)]}"
                        type="object"
                        confirm="This payment has been applied. Canceling this payment will remove it from all related invoice(s). Do you still want to cancel it?"/>
                <button name="cancel" string="Cancel" attrs="{'invisible':[('show_cancel_button', '!=', 3)]}"
                        type="object"
                        confirm="This payment has been applied. Canceling this payment will remove it from all related bill(s). Do you still want to cancel it?"/>
                <button name="cancel" string="Cancel"
                        attrs="{'invisible':[('show_cancel_button', '!=', 4)]}"
                        type="object"
                        confirm="This payment has been reconciled. Canceling this payment will make your reconciliation unbalanced. Do you still want to cancel it?"/>
                <button name="delete_payment" type="object" string="Delete" confirm="Are you sure you want to delete this payment?"/>
                <field name="has_been_voided" invisible="1"/>
                <button name="action_void" string="Void"
                        attrs="{'invisible':['|', ('has_been_voided', '!=', False), ('state', 'in', ['draft', 'cancelled'])]}"
                        type="object"
                        help="Odoo will create a reversed journal entry if you void this check. Are you sure you want to proceed?"
                        confirm="Odoo will create a reversed journal entry if you void this check. Are you sure you want to proceed?"/>
            </xpath>
        </field>
    </record>
</odoo>
